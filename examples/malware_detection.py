#!/usr/bin/env python3
"""
Malware Detection Example

Author: Jacob Krell
Status: Beta

Demonstrates malware detection workflows including:
- Hidden module detection (DirtyCLR, process hollowing)
- Injected code detection
- Suspicious DLL analysis

Usage:
    python malware_detection.py <memory_file> <pid>
    python malware_detection.py C:/evidence/memory.raw 3120
"""

import argparse
import sys
from pathlib import Path

# Add src to path for local testing
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from memory_forensics_mcp import MemoryForensicsMCP


def parse_args():
    parser = argparse.ArgumentParser(
        description="Malware detection workflow using Memory Forensics MCP",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
    python malware_detection.py C:/evidence/memory.raw 3120
    python malware_detection.py /path/to/memory.dmp 1234 --output ./results
        """
    )
    parser.add_argument(
        "memory_file",
        help="Path to the memory dump file"
    )
    parser.add_argument(
        "pid",
        type=int,
        help="Target process ID to analyze"
    )
    parser.add_argument(
        "--output", "-o",
        default="./output",
        help="Output directory for extracted artifacts (default: ./output)"
    )
    return parser.parse_args()


def main():
    args = parse_args()
    memory_file = args.memory_file
    target_pid = args.pid
    output_dir = Path(args.output)
    output_dir.mkdir(exist_ok=True)
    
    # Validate memory file exists
    if not Path(memory_file).exists():
        print(f"ERROR: Memory file not found: {memory_file}")
        sys.exit(1)
    
    # Initialize MCP
    mcp = MemoryForensicsMCP()
    
    print("=" * 70)
    print("MALWARE DETECTION WORKFLOW")
    print("=" * 70)
    print(f"Memory file: {memory_file}")
    print(f"Target PID: {target_pid}")
    print()
    
    # Step 1: Check ldrmodules for hidden DLLs
    print("-" * 70)
    print("Step 1: Checking ldrmodules for hidden modules...")
    print("-" * 70)
    
    ldr_result = mcp.ldrmodules(memory_file=memory_file, pid=target_pid)
    
    if ldr_result["success"]:
        suspicious_modules = []
        for mod in ldr_result["results"]:
            in_load = mod.get("InLoad", True)
            in_init = mod.get("InInit", True)
            in_mem = mod.get("InMem", True)
            
            # Handle string boolean values
            if isinstance(in_load, str):
                in_load = in_load.lower() == "true"
            if isinstance(in_init, str):
                in_init = in_init.lower() == "true"
            if isinstance(in_mem, str):
                in_mem = in_mem.lower() == "true"
            
            # Flag modules with suspicious loader flags
            if not in_load or not in_init or not in_mem:
                suspicious_modules.append({
                    "base": mod.get("Base"),
                    "path": mod.get("MappedPath", ""),
                    "in_load": in_load,
                    "in_init": in_init,
                    "in_mem": in_mem
                })
        
        if suspicious_modules:
            print(f"[!] Found {len(suspicious_modules)} suspicious modules:")
            for mod in suspicious_modules:
                print(f"    Base: {mod['base']}")
                print(f"    Path: {mod['path']}")
                print(f"    Flags: InLoad={mod['in_load']}, InInit={mod['in_init']}, InMem={mod['in_mem']}")
                print()
        else:
            print("[+] No suspicious ldrmodules flags detected")
    else:
        print(f"[!] ldrmodules failed: {ldr_result.get('error')}")
    print()
    
    # Step 2: Use find_hidden_modules for automated detection
    print("-" * 70)
    print("Step 2: Automated hidden module detection...")
    print("-" * 70)
    
    hidden_result = mcp.find_hidden_modules(memory_file=memory_file, pid=target_pid)
    
    if hidden_result["success"]:
        if hidden_result["count"] > 0:
            print(f"[!] Found {hidden_result['count']} hidden modules:")
            for mod in hidden_result["hidden_modules"]:
                print(f"    Base: {mod.get('base')}")
                if mod.get("has_pe_header"):
                    print(f"    [PE HEADER DETECTED]")
                if mod.get("vad_protection"):
                    print(f"    VAD Protection: {mod.get('vad_protection')}")
                print()
        else:
            print("[+] No hidden modules detected")
    else:
        print(f"[!] find_hidden_modules failed: {hidden_result.get('error')}")
    print()
    
    # Step 3: Run malfind
    print("-" * 70)
    print("Step 3: Malfind - Detecting injected code...")
    print("-" * 70)
    
    malfind_result = mcp.malfind(memory_file=memory_file, pid=target_pid)
    
    if malfind_result["success"]:
        if malfind_result["count"] > 0:
            print(f"[!] Found {malfind_result['count']} suspicious memory regions:")
            for finding in malfind_result["results"]:
                print(f"    Address: {finding.get('Start VPN')} - {finding.get('End VPN')}")
                print(f"    Protection: {finding.get('Protection')}")
                if finding.get("Hexdump"):
                    print(f"    Hexdump: {finding.get('Hexdump')[:60]}...")
                print()
        else:
            print("[+] No injected code detected by malfind")
    else:
        print(f"[!] malfind failed: {malfind_result.get('error')}")
    print()
    
    # Step 4: Dump suspicious modules
    if hidden_result.get("success") and hidden_result.get("hidden_modules"):
        print("-" * 70)
        print("Step 4: Dumping suspicious modules...")
        print("-" * 70)
        
        for i, mod in enumerate(hidden_result["hidden_modules"]):
            base = mod.get("base")
            if base:
                # Parse address
                addr = int(base, 16) if isinstance(base, str) else base
                
                output_path = output_dir / f"hidden_module_{i}_{hex(addr)}.bin"
                
                dump_result = mcp.dump_vad_raw(
                    memory_file=memory_file,
                    pid=target_pid,
                    address=addr,
                    output_path=str(output_path),
                    trim_trailing_zeros=True
                )
                
                if dump_result["success"]:
                    print(f"[+] Dumped: {output_path}")
                    print(f"    Size: {dump_result.get('size_raw')} bytes")
                    print(f"    MD5 (raw): {dump_result.get('md5_raw')}")
                    print(f"    MD5 (trimmed): {dump_result.get('md5_trimmed')}")
                    print()
                else:
                    print(f"[!] Failed to dump {base}: {dump_result.get('error')}")
    
    print("=" * 70)
    print("ANALYSIS COMPLETE")
    print("=" * 70)
    print(f"Output files saved to: {output_dir.resolve()}")
    print()
    print("Next steps:")
    print("  1. Submit hashes to VirusTotal")
    print("  2. Analyze dumped modules in Ghidra/IDA")
    print("  3. Check for known malware signatures")


if __name__ == "__main__":
    main()
